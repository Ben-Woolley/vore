{{ define "user" }}
{{ template "head" . }}
{{ template "nav" . }}

{{ $length := len .Data.Items }} {{ if eq $length 0 }}
{{ if .LoggedIn }}
<p>
you don't seem to have any feeds yet.

go to <a href="/feeds">/feeds</a> to add your first feed!
</p>
{{ end }}
{{ end }}
<ul>
{{ range .Data.Items }}
	<li{{ if and $.LoggedIn (index $.Data.ReadItems .Link) }} class="read"{{ end }}>
	<a href="/read/{{ .Link | escapeURL }}">
		{{ if .Title }} {{ .Title }} {{ else }} (empty title) {{ end }}
	</a>
	<br>
	<span class=puny title="{{ .Date }}">
		published {{ .Date | timeSince }} via
		<a href="//{{ .Link | printDomain }}">
			{{ .Link | printDomain }}</a>
		{{ if $.LoggedIn }}
		| <a href="#"
			data-save-url="/save/{{ .Link | escapeURL }}"
			onclick="saveItem(this); return false;">
			archive
		</a>
		{{ end }}
	</span>
	</li>
{{ end }}
</ul>

{{ if $.LoggedIn }}
<script>
function saveItem(element) {
  const url = element.dataset.saveUrl;
  const states = [".", "..", "..."];
  let index = 0;

  const intervalId = setInterval(() => {
    element.textContent = "archiving" + states[index];
    index = (index + 1) % states.length;
  }, 300);

  fetch(url)
    .then(response => {
      if (!response.ok) {
        throw new Error(`Request failed with status ${response.status}`);
      }
      return response.text();
    })
    .then(data => {
      clearInterval(intervalId);
      element.textContent = "archived!";
    })
    .catch(error => {
      console.error(error);
      clearInterval(intervalId);
      element.textContent = "error!";
    });
}
</script>
{{ end }}

{{ template "tail" . }}
{{ end }}
